<html>
    <head>
        <title>{{ track.name }} - Gypsum</title>
        
        <style type="text/css">
            body {
                font-family: sans;
                margin: 0px;
                padding: 0px;
            }
            
            #info {
                position: absolute;
                right: 8px;
                bottom: 32px;
                width: 360px;
                height: 220px;
                background: white;
                opacity: 0.7;
                z-index: 1;
            }
            
            .infoHeader {
                font-weight: bold;
            }
            
            #trackInfo {
                height: 100%;
            }
        </style>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/themes/base/jquery-ui.css"/>
        
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">
          var map;
          var trackLine;
          var points;
          var infoPoints;
          var isTrackOpen;
          
          $(document).ready(function() {
            var latlng = new google.maps.LatLng(57.8, 11.9);
            var myOptions = {
              zoom: 8,
              center: latlng,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map"), myOptions);
          
            $(function() {
              $("#trackInfo").tabs();
            });
            
            updateTrackData();
          });
          
          function updateTrackData() {
            $.getJSON('positions', function(data) { displayTrackData(data); });
          }
          
          function displayTrackData(data) {
            $("#trackName").text(data['name']);
            $("#trackDate").text(data['date']);
            $("#trackDistance").text((Math.round(data['distance'] * 100) / 100).toFixed(2) + " km");
            $("#trackDuration").text(data['duration']);
            $("#trackTime").text(data['start_time'] + " - " + data['end_time'] + ' (UTC)');
            $("#trackCreationTime").text(data['created_time']);
            $("#paceChart").attr("src", data['pace_chart_url']);
            $("#elevationChart").attr("src", data['elevation_chart_url']);
                              
            var positions = data['positions'];
            points = [];
            var bounds = new google.maps.LatLngBounds();
            $.each(positions, function(index, position) {
                var latlng = new google.maps.LatLng(position.fields.latitude, position.fields.longitude);
                bounds.extend(latlng);
                points.push(latlng);
            });
            
            trackLine = new google.maps.Polyline({
                path: [],
                strokeColor: '#ff0000',
                strokeOpacity: 0.6,
                strokeWeight: 6
            });
            
            trackLine.setMap(map);
            map.fitBounds(bounds);
            
            infoPoints = data.info_points;
            isTrackOpen = data.is_open;
            
            setTimeout(appendPath, 0);
          }
          
          function appendPath() {
            var path = trackLine.getPath();
            if (path.length < points.length) {
                var infoPoint = infoPoints[path.length];
                if (infoPoint) {
                    var marker = new google.maps.Marker({
                        position: points[path.length],
                        map: map,
                        title: infoPoint.distance + "km"
                    });
                    var infoWindow = new google.maps.InfoWindow({
                        content: '<em>' + infoPoint.distance + 'km</em><br/>'
                            + '<em>Total time: ' + infoPoint.total_time + '</em></br/>'
                            + '<em>Pace last km: ' + infoPoint.last_km + '</em><br/>'                        
                    });
                    google.maps.event.addListener(marker, 'click', function() {
                        infoWindow.open(map, marker);
                    });
                }
                
                path.insertAt(path.length, points[path.length]);
                setTimeout(appendPath, 0);
            } else if (isTrackOpen) {
                setTimeout(updateTrackData, 30);
            }
          }
        </script>
    </head>
    <body>
        <div id="info">
            <div id="trackInfo">
                <ul>
                    <li><a href="#trackInfo-Overview">Overview</a></li>
                    <li><a href="#trackInfo-Pace">Pace</a></li>
                    <li><a href="#trackInfo-Elevation">Elevation</a></li>
                </ul>
                <div id="trackInfo-Overview">
                    <table>
                        <tr>
                            <td class="infoHeader">Name:</td>
                            <td id="trackName"></td>
                        </tr>
                        <tr>
                            <td class="infoHeader">Date:</td>
                            <td id="trackDate"></td>
                        </tr>
                        <tr>
                            <td class="infoHeader">Distance:</td>
                            <td id="trackDistance"></td>
                        </tr>
                        <tr>
                            <td class="infoHeader">Duration:</td>
                            <td id="trackDuration"></td>
                        </tr>
                        <tr>
                            <td class="infoHeader">Time:</td>
                            <td id="trackTime"></td>
                        </tr>
                         <tr>
                            <td class="infoHeader">Uploaded/created:</td>
                            <td id="trackCreationTime"></td>
                        </tr>
                    </table>
                </div>
                <div id="trackInfo-Pace">
                    <img id="paceChart" src="" alt="Pace chart"/>
                </div>
                <div id="trackInfo-Elevation">
                    <img id="elevationChart" src="" alt="Elevation chart"/>
                </div>
            </div>
        </div>
        <div id="map" style="width: 100%; height: 100%"></div>
    </body>
</html>

